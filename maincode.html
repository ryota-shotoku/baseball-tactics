<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>野球スコア＆ランナー管理</title>
    <style>
        :root {
            --bg-color: #222;
            --field-color: #2e7d32;
            --line-color: rgba(255, 255, 255, 0.6);
            --base-color: #fff;
            --runner-color: #ffeb3b;
            --text-color: #fff;
            --card-bg: #f5f5f0;
            --card-border: #000;
            --card-text: #000;
            --attack-color: #e57373; /* 攻撃エリアのアクセント */
            --defense-color: #64b5f6; /* 守備エリアのアクセント */
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        h1 { margin: 10px 0; font-size: 1.5rem; }

        /* --- スコアボード --- */
        .scoreboard-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-collapse: collapse;
            background-color: #333;
            border: 2px solid #555;
        }

        th, td {
            border: 1px solid #555;
            padding: 4px;
            text-align: center;
            min-width: 25px;
        }

        th { background-color: #111; color: #aaa; font-size: 0.9rem; }
        
        input.team-name {
            background: transparent;
            border: none;
            color: #fff;
            font-weight: bold;
            font-size: 1.0rem;
            width: 80px;
            text-align: center;
        }
        input.team-name:focus { outline: 1px solid #f57c00; }

        .active-inning {
            background-color: #555;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { background-color: #555; }
            50% { background-color: #777; }
            100% { background-color: #555; }
        }

        /* --- グラウンド表示 --- */
        .field-display {
            position: relative;
            width: 180px;
            height: 180px;
            background-color: var(--field-color);
            margin: 40px auto 50px; 
            transform: rotate(-45deg); 
            border: 4px solid var(--line-color);
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 1;
        }

        .base {
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: var(--base-color);
            transition: background-color 0.3s;
        }
        .base-1st, .base-2nd, .base-3rd { border: 2px solid #ccc; }
        .base.occupied {
            background-color: var(--runner-color);
            box-shadow: 0 0 10px var(--runner-color);
            border-color: #fff;
        }

        .base-2nd { top: 0; right: 0; }
        .base-1st { bottom: 0; right: 0; } 
        .base-3rd { top: 0; left: 0; }
        .base-home { 
            bottom: -5px; left: -5px; 
            transform: rotate(45deg);
            clip-path: polygon(0 0, 100% 0, 100% 50%, 50% 100%, 0 50%);
            background-color: #fff;
        }

        .info-panel {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            text-align: center;
            width: 140px;
        }

        .out-count {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 4px;
        }

        .lamp {
            width: 12px; height: 12px;
            border-radius: 50%;
            background-color: #444;
            border: 1px solid #777;
        }
        .lamp.active {
            background-color: #f44336;
            box-shadow: 0 0 8px #f44336;
        }

        .inning-text {
            font-size: 1.0rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        /* --- エリア見出し --- */
        .area-container {
            width: 100%;
            max-width: 900px;
            margin-bottom: 30px;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 5px solid #ccc;
            color: #eee;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .section-header.attack { border-color: var(--attack-color); color: var(--attack-color); }
        .section-header.defense { border-color: var(--defense-color); color: var(--defense-color); }

        /* --- カード型ボタンエリア --- */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            padding: 0 5px;
        }

        .card-btn {
            background-color: var(--card-bg);
            color: var(--card-text);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 140px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            text-align: center;
            box-sizing: border-box;
            position: relative; /* インフォボタン配置のため */
        }

        .card-btn:active {
            transform: scale(0.95);
        }
        
        .card-title {
            font-weight: 900;
            font-size: 0.9rem;
            margin-bottom: 5px;
            margin-top: 10px; /* インフォボタンとの被り防止 */
        }

        /* インフォボタン */
        .info-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background-color: #9e9e9e;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: background-color 0.2s;
        }
        .info-btn:hover {
            background-color: #424242;
        }

        /* 画像配置エリア（プレースホルダー） */
        .card-img-area {
            width: 40px;
            height: 40px;
            margin-bottom: 5px;
            /* 背景を透明にする */
            background-color: transparent; 
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        
        /* 画像をセットする際のクラス */
        .card-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        /* 画像がない場合のプレースホルダーテキストを非表示にする */
        .img-placeholder-text {
            display: none !important; 
        }
        
        /* 画像が設定されていない、または空の場合は非表示（スペースは維持） */
        .card-img:not([src]), .card-img[src=""] {
            display: none;
        }

        .card-desc {
            font-size: 0.6rem;
            font-weight: bold;
            line-height: 1.2;
            color: #333;
        }

        /* --- システム操作ボタン（下部固定） --- */
        .system-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(34, 34, 34, 0.95);
            padding: 10px 10px 20px 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
            box-sizing: border-box;
            justify-content: space-between;
        }
        
        .controls-spacer {
            height: 100px;
            width: 100%;
            opacity: 0.3;
        }

        .sys-btn {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .btn-undo { background-color: #7e57c2; }
        .btn-end { background-color: #d32f2f; }
        .btn-reset { background-color: #607d8b; }

        /* --- モーダル共通 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        /* インフォ用モーダルは少しZ-indexを高く */
        #infoModal { z-index: 2500; }

        .modal-content {
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            border: 4px solid #f1c40f;
            box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);
            animation: popIn 0.3s ease-out;
            position: relative;
        }

        /* インフォモーダル特有のスタイル */
        .info-modal-content {
            border-color: #2196f3;
            text-align: left;
            padding: 20px;
        }
        
        .info-title {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            color: #1565c0;
        }
        
        .info-text {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .close-info-btn {
            background-color: #555;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #d32f2f;
            text-transform: uppercase;
        }

        .winner-text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .final-score-display {
            font-size: 3rem;
            font-weight: 900;
            margin: 20px 0;
            font-family: 'Impact', sans-serif;
            color: #2c3e50;
        }

        .modal-btn-restart {
            background-color: #2196f3;
            color: white;
            font-size: 1.2rem;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
            transition: transform 0.2s;
        }
        .modal-btn-restart:hover {
            transform: scale(1.05);
            background-color: #1976d2;
        }

        @media (max-width: 600px) {
            .controls-grid { grid-template-columns: repeat(3, 1fr); }
            .card-btn { height: 110px; }
            .card-title { font-size: 0.8rem; }
            .card-img-area { width: 35px; height: 35px; }
            .card-desc { font-size: 0.55rem; }
            .field-display { margin: 30px auto 40px; }
            
            .system-controls {
                padding: 10px 5px 20px 5px;
            }
            .sys-btn {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>

    <h1>Baseball Tactics</h1>

    <!-- スコアボード -->
    <div class="scoreboard-container">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th>TEAM</th>
                    <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                    <th>6</th><th>7</th><th>8</th><th>9</th>
                    <th>R</th>
                </tr>
            </thead>
            <tbody>
                <tr id="row-visitor">
                    <td><input type="text" class="team-name" id="name-visitor" value="VISITOR"></td>
                    <td id="v-1"></td><td id="v-2"></td><td id="v-3"></td>
                    <td id="v-4"></td><td id="v-5"></td><td id="v-6"></td>
                    <td id="v-7"></td><td id="v-8"></td><td id="v-9"></td>
                    <td id="v-total" style="font-weight:bold;">0</td>
                </tr>
                <tr id="row-home">
                    <td><input type="text" class="team-name" id="name-home" value="HOME"></td>
                    <td id="h-1"></td><td id="h-2"></td><td id="h-3"></td>
                    <td id="h-4"></td><td id="h-5"></td><td id="h-6"></td>
                    <td id="h-7"></td><td id="h-8"></td><td id="h-9"></td>
                    <td id="h-total" style="font-weight:bold;">0</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- グラウンド表示 -->
    <div class="field-display">
        <div class="base base-1st" id="base1"></div>
        <div class="base base-2nd" id="base2"></div>
        <div class="base base-3rd" id="base3"></div>
        <div class="base base-home"></div>
        <div class="info-panel">
            <div class="inning-text" id="inningDisplay">1回 表</div>
            <div>OUT</div>
            <div class="out-count">
                <div class="lamp" id="out1"></div>
                <div class="lamp" id="out2"></div>
            </div>
        </div>
    </div>

    <!-- ATTACK エリア -->
    <div class="area-container">
        <div class="section-header attack">ATTACK CARD</div>
        <div class="controls-grid">
            <!-- 1. 一塁打 -->
            <div class="card-btn" onclick="actionHit(1)">
                <div class="info-btn" onclick="showInfo(event, '一塁打', '打者がヒットを打ち、すべての走者が1つずつ進塁します。<br>打者自身も1塁に出ます。')">i</div>
                <div class="card-title">一塁打</div>
                <!-- 画像置き換え用エリア -->
                <div class="card-img-area">
                    <img src="images/1base.png" class="card-img" alt="一塁打">
                </div>
                <div class="card-desc">打者と走者を<br>一塁ずつ進める</div>
            </div>

            <!-- 2. 二塁打 -->
            <div class="card-btn" onclick="actionHit(2)">
                <div class="info-btn" onclick="showInfo(event, '二塁打', '打者がツーベースヒットを打ち、すべての走者が2つずつ進塁します。<br>打者は2塁に出ます。')">i</div>
                <div class="card-title">二塁打</div>
                <div class="card-img-area"><img src="images/2base.png" class="card-img" alt="二塁打"></div>
                <div class="card-desc">打者と走者を<br>二塁ずつ進める</div>
            </div>

            <!-- 3. 三塁打 -->
            <div class="card-btn" onclick="actionHit(3)">
                <div class="info-btn" onclick="showInfo(event, '三塁打', '打者がスリーベースヒットを打ち、すべての走者が3つずつ進塁します。<br>打者は3塁に出ます。')">i</div>
                <div class="card-title">三塁打</div>
                <div class="card-img-area"><img src="images/3base.png" class="card-img" alt="三塁打"></div>
                <div class="card-desc">打者と走者を<br>三塁ずつ進める</div>
            </div>

            <!-- 4. 本塁打 -->
            <div class="card-btn" onclick="actionHomeRun()">
                <div class="info-btn" onclick="showInfo(event, '本塁打', 'ホームラン！<br>塁上のすべてのランナーと打者が生還し、得点が入ります。')">i</div>
                <div class="card-title">本塁打</div>
                <div class="card-img-area"><img src="images/4base.png" class="card-img" alt="本塁打"></div>
                <div class="card-desc">打者と走者を<br>本塁まで進める</div>
            </div>

            <!-- 5. 三振 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '三振', '打者が三振でアウトになります。<br>ランナーは進塁しません。')">i</div>
                <div class="card-title">三振</div>
                <div class="card-img-area"><img src="images/swingout.png" class="card-img" alt="三振"></div>
                <div class="card-desc">打者を<br>アウトにする</div>
            </div>

            <!-- 2行目 -->
            <!-- 6. 四球 -->
            <div class="card-btn" onclick="actionWalk()">
                <div class="info-btn" onclick="showInfo(event, '四球', 'フォアボールです。<br>打者は1塁へ。塁が詰まっている場合は押し出しでランナーが進みます。')">i</div>
                <div class="card-title">四球</div>
                <div class="card-img-area"><img src="images/4ball.png" class="card-img" alt="四球"></div>
                <div class="card-desc">打者を<br>一塁まで進める</div>
            </div>

            <!-- 7. 盗塁 -->
            <div class="card-btn" onclick="actionSteal()">
                <div class="info-btn" onclick="showInfo(event, '盗塁', 'ランナーのみが1つ進塁します。')">i</div>
                <div class="card-title">盗塁</div>
                <div class="card-img-area"><img src="images/steal.png" class="card-img" alt="盗塁"></div>
                <div class="card-desc">走者を<br>一塁ずつ進める</div>
            </div>

            <!-- 8. 犠打 -->
            <div class="card-btn" onclick="actionSacrifice()">
                <div class="info-btn" onclick="showInfo(event, '犠打', '送りバントなどです。<br>アウトカウントが1つ増えますが、ランナーは全員1つ進塁します。')">i</div>
                <div class="card-title">犠打</div>
                <div class="card-img-area"><img src="images/gida.png" class="card-img" alt="犠打"></div>
                <div class="card-desc">打者をアウト、<br>走者を進塁させる</div>
            </div>

            <!-- 9. 犠飛 -->
            <div class="card-btn" onclick="actionSacrifice()">
                <div class="info-btn" onclick="showInfo(event, '犠飛', '犠牲フライです。<br>アウトカウントが1つ増えますが、3塁ランナー等が生還（進塁）します。')">i</div>
                <div class="card-title">犠飛</div>
                <div class="card-img-area"><img src="images/gihi.png" class="card-img" alt="犠飛"></div>
                <div class="card-desc">打者をアウト、<br>走者を進塁させる</div>
            </div>

            <!-- 10. 失策 (攻撃) -->
            <div class="card-btn" onclick="actionError()">
                <div class="info-btn" onclick="showInfo(event, '失策', '相手のエラーで出塁します。<br>打者とランナーが1つずつ進塁します。')">i</div>
                <div class="card-title">失策</div>
                <div class="card-img-area"><img src="images/error.png" class="card-img" alt="失策"></div>
                <div class="card-desc">打者・走者を<br>一塁ずつ進める</div>
            </div>
        </div>
    </div>

    <!-- DEFENSE エリア -->
    <div class="area-container">
        <div class="section-header defense">DEFENSE CARD</div>
        <div class="controls-grid">
            <!-- 11. 飛球殺 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '飛球殺', 'フライアウトです。<br>バッターアウトとなり、ランナーは動きません。')">i</div>
                <div class="card-title">飛球殺</div>
                <div class="card-img-area"><img src="images/flyout.png" class="card-img" alt="飛球殺"></div>
                <div class="card-desc">打者を<br>アウトにする</div>
            </div>

            <!-- 12. ゴロ殺 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, 'ゴロ殺', '内野ゴロなどでアウトにします。<br>バッターアウトとなります。')">i</div>
                <div class="card-title">ゴロ殺</div>
                <div class="card-img-area"><img src="images/groundout.png" class="card-img" alt="ゴロ殺"></div>
                <div class="card-desc">打者を<br>アウトにする</div>
            </div>

            <!-- 13. 三振 (守備) -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '三振', 'ピッチャーがストライクを三つ奪いました。<br>1アウトをとります。')">i</div>
                <div class="card-title">三振</div>
                <div class="card-img-area"><img src="images/swingout.png" class="card-img" alt="三振"></div>
                <div class="card-desc">打者を<br>アウトにする</div>
            </div>

            <!-- 14. 邪殺 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '邪殺', 'ファウルフライをキャッチ。<br>1アウトをとります。')">i</div>
                <div class="card-title">邪殺</div>
                <div class="card-img-area"><img src="images/falllllout.png" class="card-img" alt="邪殺"></div>
                <div class="card-desc">打者を<br>アウトにする</div>
            </div>

            <!-- 15. 牽制 -->
            <div class="card-btn" onclick="actionPickoff()">
                <div class="info-btn" onclick="showInfo(event, '牽制', '牽制球でランナーをアウトにします。<br>最も進んでいるランナーがアウトになります。')">i</div>
                <div class="card-title">牽制</div>
                <div class="card-img-area"><img src="images/kill.png" class="card-img" alt="牽制"></div>
                <div class="card-desc">走者を<br>アウトにする</div>
            </div>

            <!-- 4行目 -->
            <!-- 16. 失策 (守備) -->
            <div class="card-btn" onclick="actionError()">
                <div class="info-btn" onclick="showInfo(event, '失策', '守備のエラーにより出塁を許します。<br>打者・走者がそれぞれ1つ進塁します。')">i</div>
                <div class="card-title">失策</div>
                <div class="card-img-area"><img src="images/error.png" class="card-img" alt="失策"></div>
                <div class="card-desc">打者・走者を<br>一塁ずつ進める</div>
            </div>

            <!-- 17. 敬遠 -->
            <div class="card-btn" onclick="actionWalk()">
                <div class="info-btn" onclick="showInfo(event, '敬遠', '申告敬遠などで打者を歩かせます。<br>四球と同じ処理を行います。')">i</div>
                <div class="card-title">敬遠</div>
                <div class="card-img-area"><img src="images/runaway.png" class="card-img" alt="敬遠"></div>
                <div class="card-desc">打者を<br>一塁まで進める</div>
            </div>

            <!-- 18. 併殺 -->
            <div class="card-btn" onclick="actionDoublePlay()">
                <div class="info-btn" onclick="showInfo(event, '併殺', 'ダブルプレーです！<br>走者と打者の2つのアウトをとります。')">i</div>
                <div class="card-title">併殺</div>
                <div class="card-img-area"><img src="images/doubleplay.png" class="card-img" alt="併殺"></div>
                <div class="card-desc">打者・走者を<br>アウトにする</div>
            </div>

            <!-- 19. 美技 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '美技', 'ファインプレーでヒット性の当たりをアウトに。<br>1アウトをとります。')">i</div>
                <div class="card-title">美技</div>
                <div class="card-img-area"><img src="images/fineplay.png" class="card-img" alt="美技"></div>
                <div class="card-desc">打者の進塁を<br>一つもどす</div>
            </div>

            <!-- 20. 本塁打阻止 -->
            <div class="card-btn" onclick="actionOut()">
                <div class="info-btn" onclick="showInfo(event, '本塁打阻止', 'ホームランをキャッチしました！。<br>得点を防ぎ、アウトを1つ増やします。')">i</div>
                <div class="card-title">本塁打阻止</div>
                <div class="card-img-area"><img src="images/catchhomerun.png" class="card-img" alt="本塁打阻止"></div>
                <div class="card-desc">ホームランを<br>アウトにする</div>
            </div>
        </div>
    </div>

    <!-- フッターに隠れないようにするスペーサー -->
    <div class="controls-spacer"></div>

    <!-- システム操作ボタン (下部固定) -->
    <div class="system-controls">
        <button class="sys-btn btn-undo" onclick="undoAction()">↩ 一手戻る</button>
        <button class="sys-btn btn-end" onclick="finishGame()">試合終了</button>
        <button class="sys-btn btn-reset" onclick="confirmReset()">リセット</button>
    </div>

    <!-- ゲームセット ポップアップモーダル -->
    <div id="gameOverModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">GAME SET!</div>
            <div id="winnerText" class="winner-text">VISITOR WINS!</div>
            <div id="finalScore" class="final-score-display">0 - 0</div>
            <button class="modal-btn-restart" onclick="closeModalAndReset()">再スタート</button>
        </div>
    </div>

    <!-- インフォメーション モーダル -->
    <div id="infoModal" class="modal-overlay" onclick="closeInfo(event)">
        <div class="modal-content info-modal-content" onclick="event.stopPropagation()">
            <div id="infoTitle" class="info-title">タイトル</div>
            <div id="infoText" class="info-text">説明文がここに入ります。</div>
            <button class="close-info-btn" onclick="closeInfo(event)">閉じる</button>
        </div>
    </div>

    <script>
        // --- ゲームロジック ---
        let gameState = {
            inning: 1,
            isTop: true,
            outs: 0,
            bases: [false, false, false],
            scores: { visitor: Array(9).fill(0), home: Array(9).fill(0) }
        };
        
        let historyStack = [];

        function init() { updateUI(); }
        
        function saveState() {
            historyStack.push(JSON.parse(JSON.stringify(gameState)));
        }
        
        function undoAction() {
            if (historyStack.length === 0) {
                alert("これ以上戻れません");
                return;
            }
            gameState = historyStack.pop();
            document.getElementById('gameOverModal').style.display = 'none';
            updateUI();
        }

        // インフォメーション表示機能
        function showInfo(event, title, text) {
            // 親要素(カード)のクリックイベントを止める
            event.stopPropagation();
            
            document.getElementById('infoTitle').innerText = title;
            document.getElementById('infoText').innerHTML = text; // HTMLタグ(br)を有効にするためinnerHTML
            document.getElementById('infoModal').style.display = 'flex';
        }

        function closeInfo(event) {
            document.getElementById('infoModal').style.display = 'none';
        }

        // 1. ヒット/エラー
        function actionHit(basesHit) {
            saveState();
            let runs = 0;
            let newBases = [false, false, false];
            for (let i = 2; i >= 0; i--) {
                if (gameState.bases[i]) {
                    let next = i + basesHit;
                    if (next >= 3) runs++;
                    else newBases[next] = true;
                }
            }
            let batter = basesHit - 1;
            if (batter >= 3) runs++;
            else newBases[batter] = true;

            gameState.bases = newBases;
            addScore(runs);
            updateUI();
        }

        function actionError() { actionHit(1); }

        // 2. ホームラン
        function actionHomeRun() {
            saveState();
            let runs = 1; 
            gameState.bases.forEach(r => { if(r) runs++; });
            gameState.bases = [false, false, false];
            addScore(runs);
            updateUI();
        }

        // 3. アウト
        function actionOut() { 
            saveState();
            addOut(1); 
        }

        // 4. 四球
        function actionWalk() {
            saveState();
            let runs = 0;
            if (gameState.bases[0] && gameState.bases[1] && gameState.bases[2]) runs = 1;
            else if (gameState.bases[0] && gameState.bases[1]) gameState.bases[2] = true;
            else if (gameState.bases[0] && gameState.bases[2]) gameState.bases[1] = true;
            else if (gameState.bases[0]) gameState.bases[1] = true;
            else gameState.bases[0] = true;
            addScore(runs);
            updateUI();
        }

        // 5. 盗塁
        function actionSteal() {
            saveState();
            let runs = 0;
            let newBases = [...gameState.bases];
            if(newBases[2]) { newBases[2] = false; runs++; }
            if(newBases[1] && !newBases[2]) { newBases[1] = false; newBases[2] = true; }
            if(newBases[0] && !newBases[1]) { newBases[0] = false; newBases[1] = true; }
            gameState.bases = newBases;
            addScore(runs);
            updateUI();
        }

        // 6. 犠打/犠飛
        function actionSacrifice() {
            saveState();
            addOut(1);
            if(gameState.outs < 3) {
                let runs = 0;
                let newBases = [false, false, false];
                if(gameState.bases[2]) runs++;
                if(gameState.bases[1]) newBases[2] = true;
                if(gameState.bases[0]) newBases[1] = true;
                gameState.bases = newBases;
                addScore(runs);
            }
            updateUI();
        }

        // 7. 牽制
        function actionPickoff() {
            saveState();
            if(gameState.bases[2]) gameState.bases[2] = false;
            else if(gameState.bases[1]) gameState.bases[1] = false;
            else if(gameState.bases[0]) gameState.bases[0] = false;
            else { 
                alert("ランナーがいません"); 
                historyStack.pop();
                return; 
            }
            addOut(1);
            updateUI();
        }

        // 8. 併殺
        function actionDoublePlay() {
            saveState();
            addOut(2);
            if(gameState.outs < 3) {
                if(gameState.bases[0]) gameState.bases[0] = false;
                else if(gameState.bases[1]) gameState.bases[1] = false;
                else if(gameState.bases[2]) gameState.bases[2] = false;
            }
            updateUI();
        }

        // --- 共通処理 ---
        function addOut(num) {
            gameState.outs += num;
            if (gameState.outs >= 3) {
                gameState.outs = 3; 
                updateUI();
                
                setTimeout(() => {
                    if (!gameState.isTop && gameState.inning === 9) {
                        finishGame();
                    } else {
                        alert(`${gameState.outs}アウト！チェンジです。`);
                        changeInning();
                    }
                }, 100);
            }
        }

        function addScore(runs) {
            if (runs === 0) return;
            if (gameState.isTop) gameState.scores.visitor[gameState.inning - 1] += runs;
            else gameState.scores.home[gameState.inning - 1] += runs;
        }

        function changeInning() {
            gameState.outs = 0;
            gameState.bases = [false, false, false];

            if (!gameState.isTop && gameState.inning === 9) {
                finishGame();
                return;
            }

            if (gameState.isTop) {
                gameState.isTop = false; 
            } else {
                gameState.isTop = true;
                gameState.inning++;
                if(gameState.inning > 9) gameState.inning = 9; 
            }
            updateUI();
        }

        function confirmReset() {
            if(confirm("リセットしますか？")) resetGame();
        }

        function resetGame() {
            saveState(); 
            gameState = {
                inning: 1, isTop: true, outs: 0,
                bases: [false, false, false],
                scores: { visitor: Array(9).fill(0), home: Array(9).fill(0) }
            };
            
            for(let i=1; i<=9; i++) {
                document.getElementById(`v-${i}`).innerText = "";
                document.getElementById(`h-${i}`).innerText = "";
            }
            updateUI();
        }

        // --- ゲーム終了処理 ---
        function finishGame() {
            const vTotal = gameState.scores.visitor.reduce((a, b) => a + b, 0);
            const hTotal = gameState.scores.home.reduce((a, b) => a + b, 0);
            
            const vName = document.getElementById('name-visitor').value || "VISITOR";
            const hName = document.getElementById('name-home').value || "HOME";

            let winnerMsg = "";
            if (vTotal > hTotal) {
                winnerMsg = `<span style="color:#e57373">${vName}</span> の勝利！`;
            } else if (hTotal > vTotal) {
                winnerMsg = `<span style="color:#64b5f6">${hName}</span> の勝利！`;
            } else {
                winnerMsg = "引き分け (DRAW)";
            }

            document.getElementById('winnerText').innerHTML = winnerMsg;
            document.getElementById('finalScore').innerText = `${vTotal} - ${hTotal}`;
            document.getElementById('gameOverModal').style.display = 'flex';
        }

        function closeModalAndReset() {
            document.getElementById('gameOverModal').style.display = 'none';
            historyStack = [];
            resetGame();
        }

        function updateUI() {
            let vTotal = 0, hTotal = 0;
            gameState.scores.visitor.forEach((score, idx) => {
                const el = document.getElementById(`v-${idx+1}`);
                el.innerText = "";
                
                if (idx + 1 <= gameState.inning) {
                    if (idx + 1 < gameState.inning || (idx + 1 === gameState.inning && gameState.isTop)) {
                        el.innerText = score;
                    }
                }
                vTotal += score;
            });
            gameState.scores.home.forEach((score, idx) => {
                const el = document.getElementById(`h-${idx+1}`);
                el.innerText = "";

                if (idx + 1 <= gameState.inning) {
                    if (idx + 1 < gameState.inning || (idx + 1 === gameState.inning && !gameState.isTop)) {
                         el.innerText = score;
                    }
                }
                hTotal += score;
            });

            document.getElementById('v-total').innerText = vTotal;
            document.getElementById('h-total').innerText = hTotal;

            document.getElementById('row-visitor').style.backgroundColor = 'transparent';
            document.getElementById('row-home').style.backgroundColor = 'transparent';
            
            if (gameState.isTop) document.getElementById('row-visitor').classList.add('active-inning');
            else document.getElementById('row-home').classList.add('active-inning');

            document.getElementById('base1').classList.toggle('occupied', gameState.bases[0]);
            document.getElementById('base2').classList.toggle('occupied', gameState.bases[1]);
            document.getElementById('base3').classList.toggle('occupied', gameState.bases[2]);

            const out1 = document.getElementById('out1');
            const out2 = document.getElementById('out2');
            out1.classList.remove('active');
            out2.classList.remove('active');
            if (gameState.outs >= 1) out1.classList.add('active');
            if (gameState.outs >= 2) out2.classList.add('active');

            document.getElementById('inningDisplay').innerText = `${gameState.inning}回 ${gameState.isTop ? '表' : '裏'}`;
        }

        init();
    </script>
</body>
</html>
